name: build

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
  
env:
  ZIP_NAME: UE4-DDS-Tools
  GUI_VERSION: v0.3.0
  PYTHON_VER: 3.10.11
  PYTHON_VER_SHORT: 310

jobs:
  build:
    runs-on: windows-2022
    steps:
    
      - name: Check tag
        run: |
          if [[ ${{ github.ref }} == refs/tags/v* ]]; then
            TAG=$(echo ${{ github.ref }} | sed -e "s#refs/tags/##g")
          else
            TAG=$(echo ${{ github.sha }} | cut -c1-7)
          fi
          echo "TAG=$TAG" >> "$GITHUB_ENV"
        shell: bash
        
      - uses: actions/checkout@v3
      - run: git submodule update --init --recursive external/Texconv-Custom-DLL
      
      - name: Download embeddable python
        run: |
          mkdir -p release/python
          curl -OL https://www.python.org/ftp/python/${{env.PYTHON_VER}}/python-${{env.PYTHON_VER}}-embed-amd64.zip
          unzip -d python-${{env.PYTHON_VER}}-embed-amd64 python-${{env.PYTHON_VER}}-embed-amd64.zip
          cd python-${{env.PYTHON_VER}}-embed-amd64
          cp python.exe ../release/python
          cp python${{env.PYTHON_VER_SHORT}}.dll ../release/python
          cp libffi-7.dll ../release/python
          cp _ctypes.pyd ../release/python
          cp _multiprocessing.pyd ../release/python
          cp _socket.pyd ../release/python
          cp select.pyd ../release/python
          cp LICENSE.txt ../release/python
          bash ../.github/workflows/edit_python_zip.sh
        shell: bash

      - name: Zip python${{env.PYTHON_VER_SHORT}}
        run: |
          cd python-${{env.PYTHON_VER}}-embed-amd64
          cd python${{env.PYTHON_VER_SHORT}}
          Compress-Archive -Force -Path * -Destination ../python${{env.PYTHON_VER_SHORT}}.zip
          cd ..
          Remove-Item -Force -Recurse -Path python${{env.PYTHON_VER_SHORT}}
          Copy-Item -Path python${{env.PYTHON_VER_SHORT}}.zip -Destination ../release/python

      - name: build dll
        run: |
          external/Texconv-Custom-DLL/batch_files/build_wic_support.bat
          mkdir -p release/src/directx
          cp external/Texconv-Custom-DLL/texconv.dll release/src/directx

      - name: Copy files
        run: |
          cp -r src release
          cp docs/changelog.txt release
          cp docs/README.url release
          cp LICENSE release
          cp -r release release_gui
          cp bat/* release
        shell: bash

      - name: Download Simple Command Runner
        run: |
          curl -OL https://github.com/matyalatte/Simple-Command-Runner/releases/download/${{env.GUI_VERSION}}/SimpleCommandRunner-${{env.GUI_VERSION}}-${{ runner.os }}.zip
          unzip -d SimpleCommandRunner SimpleCommandRunner-${{env.GUI_VERSION}}-${{ runner.os }}.zip
          cp SimpleCommandRunner/SimpleCommandRunner.exe release_gui/GUI.exe
          cp gui_definition.json release_gui
        shell: bash

      - name: Archive Release
        uses: thedoctor0/zip-release@master
        with:
          directory: 'release'
          type: 'zip'
          filename: '${{ env.ZIP_NAME }}-${{ env.TAG }}-Batch.zip'
          exclusions: '*.git* .gitignore'

      - name: Archive Release
        uses: thedoctor0/zip-release@master
        with:
          directory: 'release_gui'
          type: 'zip'
          filename: '${{ env.ZIP_NAME }}-${{ env.TAG }}-GUI.zip'
          exclusions: '*.git* .gitignore'

      - name: Create Release Draft
        id: create-release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ env.TAG }}
          name: ${{ env.TAG }}
          body: |
            Changelog
            - First Change
            - Second Change
          draft: true
          prerelease: false

      - name: Upload Release Asset
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release upload ${{ env.TAG }} release/${{ env.ZIP_NAME }}-${{ env.TAG }}-Batch.zip
          gh release upload ${{ env.TAG }} release_gui/${{ env.ZIP_NAME }}-${{ env.TAG }}-GUI.zip
